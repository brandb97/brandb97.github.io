import{j as e,c as l,r as d,H as _,F as h}from"./Footer-BCDbRi8S.js";import{C as t,B as w}from"./CodeBox-DHD9yWMe.js";const f="/assets/ibm1969-DPtM4P6B.jpg";function x(){return e.jsxs("div",{children:[e.jsxs("p",{className:"indent",children:["ç»ˆç«¯æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœä½ ç†Ÿæ‚‰UNIXç³»ç»Ÿï¼Œä½ ä¹Ÿè®¸ä¼šè¯´ç»ˆç«¯å°±æ˜¯",e.jsx("code",{children:'"/dev/tty"'}),"è¿™ä¸ªè®¾å¤‡ã€‚ä¸è¿‡ä»UNIXç¨‹åºçš„è§†è§’æ¥çœ‹ï¼ˆè¯•è¯•cat /dev/ttyï¼‰ï¼Œ/dev/ttyå’Œæ™®é€šçš„æ–‡ä»¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚åœ¨UNIXç³»ç»Ÿé‡Œï¼Œä¸€ä¸ªç¨‹åºç”¨",e.jsx("code",{children:"open"}),"ç³»ç»Ÿè°ƒç”¨æ—¢å¯ä»¥æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ‰“å¼€ä¸€ä¸ªç»ˆç«¯è®¾å¤‡ã€‚",e.jsx("code",{children:"open"}),"ç³»ç»Ÿè°ƒç”¨è¿”å›ä¸€ä¸ªæ•´æ•°ç±»å‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆå…¶å®å°±æ˜¯ä¸€ä¸ªæ•°ç»„ä¸‹æ ‡ï¼‰ï¼Œ",e.jsx("code",{children:"read/write"}),"ç³»ç»Ÿè°ƒç”¨å¯¹è¿™ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè¯»å†™æ“ä½œã€‚è®¸å¤šæ—¶å€™ï¼Œå¯¹äºä¸€ä¸ªç¨‹åºæ¥è¯´ï¼Œä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç©¶ç«Ÿå¯¹åº”äºä¸€ä¸ªç£ç›˜æ–‡ä»¶è¿˜æ˜¯å±äºä¸€ä¸ªç»ˆç«¯è®¾å¤‡å¹¶ä¸é‡è¦ï¼Œåªè¦å¯ä»¥å¯¹è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè¯»å†™æ“ä½œå°±å¯ä»¥ã€‚ä½†æ˜¯æ“ä½œç³»ç»Ÿå°±éœ€è¦åŒºåˆ†æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„è®¾å¤‡æ˜¯ä»€ä¹ˆäº†ã€‚å¦‚æœæ˜¯è¯»å†™ç¡¬ç›˜ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦ç§»åŠ¨ç¡¬ç›˜çš„ç£å¤´è¯»å†™ç£é“ä¸Šçš„æ•°æ®ï¼›å¦‚æœæ˜¯è¯»å†™ç»ˆç«¯ï¼Œæ“ä½œç³»ç»Ÿçš„ç»ˆç«¯é©±åŠ¨ç¨‹åºåˆ™éœ€è¦ç­‰å¾…é”®ç›˜çš„è¾“å…¥ï¼Œæˆ–è€…æ˜¯æŠŠasciiç æ‰“å°åœ¨å±å¹•ä¸Šã€‚"]}),e.jsxs("p",{className:"indent",children:["æ‰€ä»¥ç»ˆç«¯è¿™ä¸ªåè¯å…¶å®å¯ä»¥å¯¹åº”ä¸¤ç§ä¸œè¥¿ï¼šç»ˆç«¯è®¾å¤‡å’Œç»ˆç«¯é©±åŠ¨ç¨‹åºã€‚åœ¨å¾ˆæ—©ä»¥å‰ï¼Œç»ˆç«¯è®¾å¤‡ï¼Œå°±æ˜¯æŒ‡é”®ç›˜å’Œå±å¹•ï¼ŒUNIXç³»ç»Ÿä¸­ç”¨",e.jsx("code",{children:'"/dev/tty"'}),"è¡¨ç¤ºï¼›ç»ˆç«¯é©±åŠ¨åˆ™è´Ÿè´£å®ç°åœ¨ç»ˆç«¯è®¾å¤‡ä¸Šçš„ç³»ç»Ÿè°ƒç”¨ï¼ˆe.g. UNIXç³»ç»Ÿä¸Šçš„openï¼Œreadï¼Œwriteï¼‰ã€‚ä¸‹é¢æ˜¯ä¸€å¼ å¤æ—©ï¼ˆ1969å¹´ï¼Œæ¥æºäºç»´åŸºç™¾ç§‘ï¼‰äººä»¬åœ¨ç»ˆç«¯ä¸Šå·¥ä½œçš„ç›¸ç‰‡ï¼ˆä¹Ÿè®¸ç°åœ¨æœ‰ä¸€äº›æ€§æ ¼å˜æ€çš„ä¹¦å‘†å­ä¹Ÿä¼šè¿™ä¹ˆå·¥ä½œï¼Œæ—å­å¤§äº†ä»€ä¹ˆé¸Ÿéƒ½æœ‰ï¼ï¼‰"]}),e.jsx("div",{className:"ibm1969-pic",children:e.jsx("img",{src:f,alt:"ibm terminal in 1969"})}),e.jsxs("div",{className:"tips",children:["ğŸ¤” ä¸ºä»€ä¹ˆç»ˆç«¯è¢«ç§°ä¸ºttyï¼Ÿ",e.jsx("br",{}),"ğŸ’¡ ttyçš„å…¨ç§°æ˜¯TeleTYpewriterï¼Œå¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œè¯·çœ‹",e.jsx("a",{href:"https://zh.wikipedia.org/zh-cn/é›»å‚³æ‰“å­—æ©Ÿ",children:"ç”µä¼ æ‰“å°æœº"})]})]})}function p(){return e.jsxs("div",{children:[e.jsx("p",{className:"indent",children:"è¿˜è®°å¾—æˆ‘è¯´è¿‡â€œå¤§éƒ¨åˆ†ç¨‹åºä¸å…³å¿ƒæ–‡ä»¶æè¿°ç¬¦æ˜¯ä»€ä¹ˆè®¾å¤‡â€å—ï¼Ÿä½†çš„ç¡®å­˜åœ¨ä¸€äº›ç¨‹åºå°±æ˜¯é’ˆå¯¹ç»ˆç«¯ç¼–å†™çš„ï¼Œæ¯”å¦‚vimã€‚æƒ³æƒ³vimè¦å¦‚ä½•å®ç°é¡µé¢æ»šåŠ¨çš„åŠŸèƒ½å‘¢ï¼Ÿé¦–å…ˆï¼Œviméœ€è¦å‘Šè¯‰ç»ˆç«¯é©±åŠ¨ç¨‹åºå…³é—­è¡Œç¼“å†²åŠŸèƒ½ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç»ˆç«¯é©±åŠ¨ç¨‹åºä¼šåœ¨ç”¨æˆ·æŒ‰ä¸‹ENTERæ—¶æ‰æŠŠè¾“å…¥å‘é€ç»™åº”ç”¨ç¨‹åºï¼Œä½†å¯¹äºvimï¼Œå¦‚æœæˆ‘ä»¬æ¯æ¬¡è¦åˆ°æŒ‰â€œä¸‹ç®­å¤´+ENTERâ€æ‰èƒ½å‘ä¸‹æ»šåŠ¨æ˜¾ç„¶å¾ˆä¸æ–¹ä¾¿ã€‚å…¶æ¬¡ï¼Œåœ¨è¯»å–åˆ°ç”¨æˆ·è¾“å…¥çš„ä¸‹ç®­å¤´ä¹‹åï¼Œviméœ€è¦ç»“åˆå…‰æ ‡çš„ä½ç½®å’Œç»ˆç«¯æ˜¾ç¤ºå™¨çš„å®½åº¦åˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨é¡µé¢ã€‚åœ¨UNIXç³»ç»Ÿä¸­ï¼Œç”¨æ¥è·å–å’Œè®¾ç½®ç»ˆç«¯çš„ç³»ç»Ÿè°ƒç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š"}),e.jsx(t,{code:`/* è·å–ç»ˆç«¯å±æ€§ï¼Œe.g.æ˜¯å¦è¡Œç¼“å†² */
int tcgetattr(int fildes, struct termios *termios_p);

/* è®¾ç½®ç»ˆç«¯å±æ€§ */
int tcsetattr(int fildes, int optional_actions, const struct termios *termios_p);

struct winsize {
    unsigned short ws_row;
    unsigned short ws_col;
    unsigned short ws_xpixel;
    unsigned short ws_ypixel;
} ws;

/* è·å–/è®¾ç½®ç»ˆç«¯çª—å£å¤§å° */
if (ioctl(STDIN_FILENO, TIOCGWINSZ, &ws) == -1)
    fprintf(stderr, "è¯»å–ç»ˆç«¯çª—å£å¤§å°é”™è¯¯\\n");`,language:"c"}),e.jsxs("p",{className:"indent",children:["æŠ›å¼€vimä¸è°ˆï¼Œä½ æ˜¯å¦æƒ³è¿‡å½“æŒ‰ä½ ä¸‹CTRL-Cæ—¶ä¸ºä»€ä¹ˆå¯ä»¥è®©ç¨‹åºç»ˆæ­¢å‘¢ï¼Ÿå½“ç”¨æˆ·è¾“å…¥äº†CTRL-Cï¼Œç»ˆç«¯é©±åŠ¨å¹¶ä¸ä¼šå°†CTRL-Cæ”¾åˆ°è¾“å…¥ç¼“å†²åŒºä¾›ç¨‹åºè¯»å–ï¼Œå–è€Œä»£ä¹‹çš„äº‹æƒ…æ˜¯ï¼Œç»ˆç«¯é©±åŠ¨ä¼šå‘ç¨‹åºå‘é€SIGINTï¼Œä»è€Œå¯¼è‡´ç¨‹åºç»ˆæ­¢ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•è®©ç»ˆç«¯é©±åŠ¨ä¸è¦è¿™ä¹ˆåšå‘¢ï¼Ÿä½ å¯ä»¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨",e.jsx("code",{children:"tcsetattr"}),"ï¼Œæˆ–è€…æ›´ç®€å•çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨",e.jsx("code",{children:"stty"}),"å‘½ä»¤ï¼š"]}),e.jsx(t,{code:`stty -isig   # ä¸å…è®¸ç‰¹æ®Šå­—ç¬¦å‘é€ä¿¡å·
stty isig    # æ¢å¤ç‰¹æ®Šå­—ç¬¦å‘é€ä¿¡å·
stty intr ^L # è®¾ç½®ä¸­æ–­ä¿¡å·å¯¹äºçš„å­—ç¬¦æ˜¯CTRL-L`,language:"bash"}),e.jsxs("p",{className:"indent",children:["è¯´äº†è¿™ä¹ˆå¤šï¼Œå¤§å®¶åº”è¯¥æ˜ç™½ï¼šé™¤äº†è¯»å†™æ“ä½œï¼Œç»ˆç«¯æ–‡ä»¶æè¿°ç¬¦å’Œæ™®é€šæ–‡ä»¶æè¿°ç¬¦çš„åŒºåˆ«å¾ˆå¤§ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸Šé¢æåˆ°çš„ç³»ç»Ÿè°ƒç”¨ä»ç»ˆç«¯æ–‡ä»¶æè¿°ç¬¦ä¸­è·å–è®¸å¤šæ™®é€šæ–‡ä»¶æè¿°ç¬¦ä¸­æ²¡æœ‰çš„ä¿¡æ¯ã€‚ä½†æ˜¯æ™®é€šæ–‡ä»¶ç¬¦èƒ½åšçš„",e.jsx("code",{children:"lseek"}),"ï¼ˆå°†ç£ç›˜è¯»å†™å¤´ç§»åˆ°æ–‡ä»¶çš„æŸä¸ªæŒ‡å®šä½ç½®ï¼‰ï¼Œåˆ™å¯¹äºç»ˆç«¯è®¾å¤‡æ²¡æœ‰æ„ä¹‰ã€‚"]})]})}const m="/assets/window_prog-Disl9x2E.jpeg",j="/assets/window_shell-DmLOIUQH.jpeg",u="/assets/screen_like-uICQQPGK.jpeg";function g(){return e.jsxs("div",{children:[e.jsx("p",{className:"indent",children:"å¤æ—©æ—¶æœŸï¼Œçª—å£=æ˜¾ç¤ºå™¨ã€‚ä½†ç°åœ¨ï¼Œæˆ‘ä»¬ä¼šåœ¨æ˜¾ç¤ºå™¨ä¸­æ‰“å¼€ä¸€å¤§å †çª—å£ï¼Œæ¯ä¸ªçª—å£ä¸­è¿è¡Œä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„ç»“æ„å¯ä»¥ç”¨ä¸‹é¢è¿™å¹…å›¾ç‰‡æè¿°"}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx("img",{src:m,alt:"windows program frame",style:{width:"70%"}})}),e.jsx("p",{className:"indent",children:"ä¸ºäº†è®©shellç¨‹åºä¹Ÿå¯ä»¥è¿è¡Œåˆ°çª—å£ä¸Šï¼Œäººä»¬å¼€å‘äº†è®¸å¤šä¸“é—¨è¿è¡Œshellå‘½ä»¤çš„çª—å£ç¨‹åºï¼ˆæ¯”å¦‚iTermï¼Œwarpç­‰ç­‰ï¼‰ã€‚è¿™äº›ç¨‹åºçš„ç»“æ„å¦‚ä¸‹æ‰€ç¤º"}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx("img",{src:j,alt:"windows shell frame",style:{width:"77%"}})}),e.jsx("p",{className:"indent",children:"çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œå¯¹ä¸å¯¹ï¼Ÿä¸è¿‡ä½ ä¹Ÿè®¸ä¼šé—®ï¼šä»€ä¹ˆæ˜¯ä¼ªç»ˆç«¯ï¼ˆè‹±æ–‡ç®€ç§°æ˜¯ptyï¼‰ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œä¼ªç»ˆç«¯ä¸æ˜¯çœŸå®çš„è®¾å¤‡ï¼Œå¦‚æœä½ ç†Ÿæ‚‰UNIXç³»ç»Ÿï¼Œä¼ªç»ˆç«¯çœ‹èµ·æ¥æ›´åƒæ˜¯ç®¡é“ã€‚ä½†æ˜¯ï¼Œä¼ªç»ˆç«¯é™¤äº†å…·æœ‰ç®¡é“çš„åŠŸèƒ½ï¼Œè¿˜å¯ä»¥åƒæ­£å¸¸çš„ç»ˆç«¯ä¸€æ ·è·å–çª—å£å¤§å°ï¼Œè®¾ç½®å„ç§å„æ ·çš„å±æ€§ã€‚åœ¨ä¸Šé¢çš„å›¾ç‰‡ä¸­ï¼Œå½“shellçª—å£åº”ç”¨è¢«æ‰“å¼€æ—¶ï¼Œshellçª—å£åº”ç”¨å°±ä¼šæ‰“å¼€ä¸€ä¸ªä¼ªç»ˆç«¯ï¼Œè®¾ç½®ä¼ªç»ˆç«¯çš„çª—å£å¤§å°ä¸ºshellçª—å£åº”ç”¨çš„çª—å£å¤§å°ï¼Œç„¶ååœ¨ä¼ªç»ˆç«¯çš„ä¸€è¾¹è¿è¡Œbashç¨‹åºï¼Œä¸€è¾¹è¯»å–bashç¨‹åºçš„è¾“å‡º/å‘é€ç”¨æˆ·çš„è¾“å…¥ã€‚å¦‚æœç”¨æˆ·è¾“å…¥äº†CTRL-Cåˆ°ä¼ªç»ˆç«¯è®¾å¤‡ï¼Œä¼ªç»ˆç«¯è®¾å¤‡ä¹Ÿä¸ä¼šåƒç®¡é“ä¸€æ ·å‘é€CTRL-Cåˆ°å¦ä¸€ç«¯ï¼Œè€Œæ˜¯ä¼šæƒ³ç»ˆç«¯ä¸€æ ·å¯¹å¦ä¸€ç«¯çš„ç¨‹åºå‘é€SIGINTä¿¡å·ã€‚"}),e.jsx("p",{className:"indent",children:"Whewï¼è¯´äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºå¯ä»¥è°ˆè°ˆscreenè¿™æ ·çš„çª—å£ç®¡ç†ç¨‹åºè¯¥æ€ä¹ˆå®ç°äº†ï¼Œä¸€ä¸ªç®€å•çš„æƒ³æ³•æ˜¯è¿™æ ·"}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx("img",{src:u,alt:"screen frame",style:{width:"77%"}})}),e.jsxs("p",{className:"indent",children:["è¿™å¼ å›¾ç‰‡ä¸­ï¼Œscreenç¨‹åºä½œä¸ºå‰ç«¯ï¼Œè¯»å–ç”¨æˆ·è¾“å…¥åªéœ€è¦åœ¨æ ‡å‡†è¾“å…¥",e.jsx("code",{children:"STDIN_FILENO"}),"ä¸Šè°ƒç”¨",e.jsx("code",{children:"read"}),"ï¼Œæ¸²æŸ“çª—å£åªéœ€è¦æŠŠç¨‹åºè¾“å‡º",e.jsx("code",{children:"printf"}),"åˆ°æ ‡å‡†è¾“å‡ºï¼ˆä¹‹åshellçª—å£ç¨‹åºâ€”â€”æ¯”å¦‚MacOSä¸Šçš„iTermç¨‹åºï¼Œä¼šæŠŠæ ‡å‡†è¾“å‡ºçš„å­—ç¬¦ç»˜åˆ¶åˆ°çª—å£ä¸­ï¼‰ã€‚screenå¯ä»¥æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼ˆe.g. ",e.jsx("code",{children:"screen -a -t 0"}),"ï¼‰æ¥å…¥ï¼ˆattachï¼‰åˆ°ä¸€ä¸ªä¼ªç»ˆç«¯ï¼Œä¹Ÿå¯ä»¥ç¦»å¼€ï¼ˆdetachï¼‰å½“å‰ä¼ªç»ˆç«¯ï¼Œæ¥å…¥å…¶ä»–ä¼ªç»ˆç«¯ï¼Œè¿™æ ·å°±å®ç°äº†çª—å£ç®¡ç†å’Œåˆ‡æ¢ã€‚å½“ç„¶ï¼Œå®ç°screenè¦è€ƒè™‘çš„äº‹æƒ…æ¯”ä¸Šé¢è¯´çš„å…¶å®è¿˜è¦å¤šå¾ˆå¤šï¼Œä½†è¿™ç¯‡åšå®¢ä¸­çš„å®ç°ä¼šä¿æŒå°½å¯èƒ½ç®€å•ã€‚myscreenè™½ç„¶è¾“å‡ºæ²¡æœ‰screenæ¼‚äº®ï¼Œä¸è¿‡ç®¡ç†å’Œåˆ‡æ¢çª—å£çš„æ€æƒ³å’Œscreenæ˜¯ä¸€è‡´çš„ã€‚"]})]})}function I(){return e.jsxs("div",{children:[e.jsxs("p",{className:"indent",children:["ç»ˆäºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹è¯¥æ€ä¹ˆå†™ä»£ç äº†ã€‚ä½ å¯ä»¥åœ¨",e.jsx("a",{href:"https://github.com/brandb97/myscreen",children:"è¿™é‡Œ"}),"ä¸‹è½½ä¸€ä»½myscreençš„ä»£ç ã€‚ç„¶åè¿è¡Œ",e.jsx("code",{children:"make"}),"å¾—åˆ°ä¸€ä»½å¯æ‰§è¡Œæ–‡ä»¶",e.jsx("code",{children:"myscreen"}),"ã€‚"]}),e.jsx(t,{code:`git clone https://github.com/brandb97/myscreen
cd myscreen
make
./myscreen`,language:"bash"}),e.jsx("p",{children:"è¿™æ—¶ä½ åº”è¯¥å·²ç»è¿›å…¥äº†ä¸€ä¸ªbashç•Œé¢äº†ï¼ŒæŒ‰ä¸‹CTRL-A då°±å¯ä»¥å’Œbashåˆ†ç¦»ã€‚å¦‚æœä½ æƒ³ç»§ç»­åˆšæ‰çš„å·¥ä½œï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤"}),e.jsx(t,{code:`./myscreen -l # åˆ—å‡ºæ‰€æœ‰çª—å£ä¿¡æ¯
./myscreen -a 0 # attachåˆ°ç¬¬0ä¸ªçª—å£
# æˆ–è€…è¯•è¯•./myscreen -a myscreen.0ï¼Œè¡¨ç¤ºattachåˆ°åå­—æ˜¯myscreen.0çš„çª—å£`,language:"bash"}),e.jsx("p",{children:"å¦‚æœä½ æƒ³åœ¨çª—å£ä¸­è¿è¡ŒæŒ‡å®šçš„ç¨‹åºï¼Œæ¯”å¦‚vimï¼Œè¯•è¯•ä¸‹é¢çš„å‘½ä»¤ï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œmyscreenä¼šåœ¨æ–°çª—å£ä¸­æ‰“å¼€vimç¼–è¾‘å™¨ã€‚ğŸ‰Hooray!"}),e.jsx(t,{code:`# ./myscreen cmd args...ï¼Œæ–°å»ºä¸€ä¸ªçª—å£å¹¶åœ¨è¿™ä¸ªçª—å£ä¸­è¿è¡Œcmd args...
./myscreen vim`,language:"bash"})]})}const N="/assets/code_struct-Nb4mniTo.jpeg";function k(){return e.jsxs("div",{children:[e.jsxs("p",{className:"indent",children:["ä¸ºäº†æ›´å¥½çš„ä»‹ç»ä»£ç ï¼Œè¿™é‡Œå…ˆä»‹ç»ä¸€ä¸‹ä»£ç çš„ç»“æ„ã€‚myscreençš„ä»£ç å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå‰ç«¯å’Œåç«¯ã€‚å‰ç«¯ä»£ç å®šä¹‰åœ¨",e.jsx("code",{children:"myscreen.c"}),"ä¸­çš„",e.jsx("code",{children:"do_interact_window()"}),"ï¼Œåç«¯ä»£ç å®šä¹‰åœ¨",e.jsx("code",{children:"window.c"}),"ä¸­çš„",e.jsx("code",{children:"do_window_task()"}),"ã€‚å‰ç«¯å’Œåç«¯é€šè¿‡UNIX-domain socketé€šä¿¡ï¼ˆUNIXç³»ç»Ÿå…è®¸æœ¬åœ°çš„ä¸¤ä¸ªè¿›ç¨‹é€šè¿‡UNIX domain socketå»ºç«‹TCPè¿æ¥ï¼‰ã€‚myscreençš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š"]}),e.jsx("div",{style:{textAlign:"center"},children:e.jsx("img",{src:N,alt:"code struct jpeg picture",style:{width:"80%"}})}),e.jsxs("p",{className:"indent",children:["myscreenä¸­çš„socket.hå’Œsocket.cå®šä¹‰äº†ç”¨äºå‰åç«¯é€šä¿¡çš„ä¸‰ä¸ªå‡½æ•°ã€‚",e.jsx("code",{children:"socket_path_create"}),"éšæœºç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå¥—æ¥å­—é€šä¿¡çš„åœ°å€ã€‚å°±åƒç½‘ç»œé€šä¿¡éœ€è¦IPåœ°å€ä¸€æ ·ï¼Œä½¿ç”¨UNIX-domain socketæ—¶ï¼Œä½ å¯ä»¥éšæœºæŒ‡å®šä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„ä½œä¸ºé€šä¿¡åœ°å€ã€‚åœ¨é€šä¿¡æ—¶ï¼Œè¿™ä¸ªæŒ‡å®šçš„æ–‡ä»¶è·¯å¾„ä¼šè¢«åˆ›å»ºæˆä¸€ä¸ªå¥—æ¥å­—ç±»å‹çš„æ–‡ä»¶ç”¨æ¥é€šä¿¡ã€‚",e.jsx("code",{children:"socket_server_xstart"}),"æ¥æ”¶ä¸€ä¸ªå¥—æ¥å­—è·¯å¾„ä½œä¸ºå‚æ•°ï¼Œåœ¨è¿™ä¸ªè·¯å¾„ä¸Šå¯åŠ¨ä¸€ä¸ªTCPæœåŠ¡å™¨ï¼Œç›‘å¬è¯¥è·¯å¾„ä¸Šçš„è¿æ¥ï¼ˆç›‘å¬ä¼šå¯¼è‡´å¥—æ¥å­—æ–‡ä»¶è¢«åˆ›å»ºï¼‰ï¼Œè¿”å›å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚",e.jsx("code",{children:"socket_server_xaccept"}),"ç”¨æ¥åœ¨ä¸€ä¸ªå·²ç»ç›‘å¬çš„å¥—ä»¶å­—æ–‡ä»¶æè¿°ç¬¦ä¸Šå’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼ˆå› ä¸ºå»ºç«‹è¿æ¥çš„ç³»ç»Ÿè°ƒç”¨å«",e.jsx("code",{children:"accept"}),"ï¼Œæ‰€ä»¥èµ·äº†è¿™ä¸ªåå­—ï¼‰ã€‚"]}),e.jsxs("div",{className:"tips",children:["ğŸ¤” ä¸ºä»€ä¹ˆè¦å«socket_server_xstart()è€Œä¸æ˜¯socket_server_start()ï¼Ÿ",e.jsx("br",{}),"ğŸ’¡ socket_server_xstart()è¡¨ç¤ºå‘ç”Ÿé”™è¯¯ç›´æ¥exit(EXIT_FAILURE)ï¼Œsocket_server_start()è¡¨ç¤ºå‘ç”Ÿé”™è¯¯returné”™è¯¯ä»£ç ï¼Œæ¯”å¦‚return -1ã€‚"]}),e.jsxs("p",{className:"indent",children:[e.jsx("code",{children:"socket_client_start"}),"å¯åŠ¨ä¸€ä¸ªå®¢æˆ·ç«¯ç”¨æ¥å’Œå‚æ•°",e.jsx("code",{children:"path"}),"æŒ‡å®šçš„åœ°å€ä¸Šçš„æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚è¿™é‡Œçš„ä»£ç æœ‰ç‚¹å¤æ‚ã€‚ç¬¬17è¡Œé¦–å…ˆåˆ¤æ–­",e.jsx("code",{children:"path"}),"æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯åç«¯ä¸å­˜åœ¨æˆ–è€…å´©æºƒäº†ï¼Œä¹Ÿå¯èƒ½æ˜¯ç”±äºsocket_server_xstartå’Œsocket_client_startæ˜¯åˆ†åˆ«åœ¨å‰/åç«¯è¿›ç¨‹ä¸­å¹¶è¡Œè°ƒç”¨çš„ï¼Œåœ¨è°ƒç”¨socket_client_startæ—¶ï¼Œåç«¯è¿›ç¨‹è¿˜æ²¡æ¥å¾—åŠåˆ›å»ºå¥—æ¥å­—æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©ç­‰å¾…ä¸€ç§’é’Ÿé™ä½æœ€åä¸€ç§æƒ…å†µå‡ºç°çš„æ¦‚ç‡ã€‚æ¥ç€æˆ‘ä»¬ä½¿ç”¨connectç³»ç»Ÿè°ƒç”¨å°è¯•å’ŒæœåŠ¡å™¨è¿æ¥ã€‚åœ¨connectçš„ç»ˆç«¯å¤±è´¥åŸå› ä¸­ï¼ŒEINPROGESSè¡¨ç¤ºæœåŠ¡å™¨è¿˜åœ¨å‡†å¤‡ç›‘å¬ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…æœåŠ¡å™¨å‡†å¤‡å¥½ã€‚æ‰€ä»¥å¦‚æœå‡ºç°äº†EINPROGESSï¼Œæˆ‘ä»¬å°±ä½¿ç”¨selectç³»ç»Ÿè°ƒç”¨ç­‰å¾…æœåŠ¡å™¨ç›‘å¬å®Œæ¯•ã€‚å¦åˆ™ï¼Œè¯´æ˜è¿æ¥å¤±è´¥äº†ï¼Œæˆ‘ä»¬æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œå¹¶è¿”å›-1ã€‚"]}),e.jsx(t,{code:`int socket_client_start(const char *path)
{
	int sockfd;
	struct sockaddr_un addr;
	fd_set write_set;

	sockfd = socket(AF_UNIX, SOCK_STREAM, 0);
	if (sockfd < 0) {
		perror_raw("Error socket() failed");
		return -1;
	}

	memset(&addr, 0, sizeof(addr));
	addr.sun_family = AF_UNIX;
	strncpy(addr.sun_path, path, sizeof(addr.sun_path) - 1);

	if (access(path, F_OK) == -1)
		sleep(1);
	while (connect(sockfd, (struct sockaddr *)&addr, sizeof(addr)) < 0) {
		if (errno != EINPROGRESS) {
			perror_raw("Error connect() failed");
			return -1;
		}

		/* Wait for the socket to be writable and retry */
		FD_ZERO(&write_set);
		FD_SET(sockfd, &write_set);
		if (select(sockfd + 1, NULL, &write_set, NULL, NULL) < 0) {
			perror_raw("Error waiting for connection");
			return -1;
		}
	}

	return sockfd;
}
`,language:"c"}),e.jsx("p",{className:"indent",children:"tty.cå’Œtty.hä¸­å®šä¹‰äº†è®¾ç½®rawæ¨¡å¼å’Œè·å–å½“å‰ç»ˆç«¯çª—å£å¤§å°çš„ç³»ç»Ÿè°ƒç”¨wrapperå‡½æ•°ã€‚rawæ¨¡å¼è¡¨ç¤ºç”¨æˆ·è¾“å…¥ä»€ä¹ˆï¼Œå‰ç«¯å°±è¯»å‡ºä»€ä¹ˆï¼Œå‰ç«¯å†™å…¥ä»€ä¹ˆï¼Œæ˜¾ç¤ºå™¨ä¸Šå°±æ‰“å°ä»€ä¹ˆã€‚æ¯”å¦‚ç”¨æˆ·è¾“å…¥CTRL-Cï¼Œå‰ç«¯å°±è¯»å‡ºCTRL-Cï¼Œè€Œä¸æ˜¯æ”¶åˆ°SIGINTä¿¡å·ï¼ˆä»£ç ä¸­å…³é—­äº†ISIGï¼‰ã€‚å†æ¯”å¦‚å‰ç«¯è¾“å‡º\\nï¼Œæ˜¾ç¤ºå™¨å°±æ‰“å°\\nï¼Œè€Œä¸æ˜¯æ‰“å°\\n\\rï¼ˆæ­£å¸¸æƒ…å†µä¸‹ç»ˆç«¯é©±åŠ¨ç¨‹åºä¼šè¿™ä¹ˆåšï¼‰ã€‚å‰ç«¯éœ€è¦è¿›å…¥rawæ¨¡å¼çš„åŸå› æ˜¯å‰ç«¯åªæ˜¯ä¸€ä¸ªä¸­è½¬ç«™ï¼Œæˆ‘ä»¬åº”è¯¥æŠŠå¤„ç†ç‰¹æ®Šå­—ç¬¦çš„å·¥ä½œäº¤ç»™ä¼ªç»ˆç«¯å¤„ç†ï¼Œè¿™æ ·å½“ç”¨æˆ·è¾“å…¥CTRL-Cæ—¶ï¼Œä¸æ˜¯å‰ç«¯ä¼šç»ˆæ­¢ï¼Œè€Œæ˜¯å·¥ä½œåœ¨ä¼ªç»ˆç«¯ä¸Šçš„è¿›ç¨‹ä¼šç»ˆæ­¢ã€‚å¦ä¸€ä»¶é‡è¦çš„äº‹æ˜¯rawæ¨¡å¼ä¸‹ä¼šå…³é—­è¡Œç¼“å†²ï¼Œå‰ç«¯å¯ä»¥ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦çš„è¯»å‡ºï¼Œè€Œä¸éœ€è¦ç­‰å¾…ç”¨æˆ·è¾“å…¥\\nã€‚ç”±äºæˆ‘å¸Œæœ›åœ¨è¾“å…¥CTRL-a dæ—¶å‰ç«¯å¯ä»¥æ–­å¼€è¿æ¥ï¼Œå…³é—­è¡Œç¼“å†²å¾ˆé‡è¦ã€‚"}),e.jsxs("p",{className:"indent",children:["pty.cå’Œpty.hä¸­å®šä¹‰äº†åç«¯ç”¨æ¥æ‰“å¼€ä¼ªç»ˆç«¯è®¾å¤‡ï¼Œå¹¶åœ¨ä¼ªç»ˆç«¯è®¾å¤‡ä¸Šå¯åŠ¨è¿›ç¨‹çš„ä»£ç ã€‚",e.jsx("code",{children:"pty_info_alloc"}),"æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„wrapperå‡½æ•°ï¼Œç”¨æ¥æ‰“å¼€ä¸€å¯¹ä¼ªç»ˆç«¯ä¸»ä»è®¾å¤‡ã€‚æ‰€è°“ä¸»ä»è®¾å¤‡ï¼Œå…¶å®åŸºæœ¬ä¸Šç­‰äºä¸€ä¸ªç®¡é“çš„ä¸¤ç«¯ã€‚ç³»ç»Ÿè°ƒç”¨",e.jsx("code",{children:"posix_openpt"}),"è¿”å›ä¸€ä¸ªä¼ªç»ˆç«¯ä¸»è®¾å¤‡çš„å¯ä¾›è¯»å†™çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç³»ç»Ÿè°ƒç”¨",e.jsx("code",{children:"ptsname"}),"è¿”å›ä¸»è®¾å¤‡å¯¹åº”çš„ä»è®¾å¤‡çš„è®¾å¤‡åï¼ˆ/dev/xxxï¼‰ã€‚æœ‰äº†ä»è®¾å¤‡çš„åå­—ï¼Œå·¥ä½œæ—©ä»è®¾å¤‡ä¸Šçš„åº”ç”¨ç¨‹åºå°±å¯ä»¥è°ƒç”¨ç†Ÿæ‚‰çš„openï¼Œreadï¼Œ writeç­‰ç³»ç»Ÿè°ƒç”¨äº†ã€‚",e.jsx("code",{children:"pty_info_xexec"}),'æ–°å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œç”¨æ¥æ‰§è¡Œç”¨æˆ·é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼ˆæˆ–è€…é»˜è®¤æ˜¯"bash"ï¼‰ã€‚ä¸è¿‡ä½ ä¹Ÿè®¸å‘ç°ï¼Œæ–°å»ºè¿›ç¨‹çš„å‘½ä»¤åªæœ‰ä¸€è¡Œ',e.jsx("code",{children:"execvp"}),"ï¼Œé‚£ä¹ˆé™¤äº†",e.jsx("code",{children:"fork + exec"}),"å¤–ï¼Œ",e.jsx("code",{children:"pty_info_xexec"}),"è¿˜åšäº†ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢ä»£ç çš„32-43è¡Œè®¾ç½®äº†ä¼ªç»ˆç«¯çš„å±æ€§å’Œçª—å£å¤§å°ï¼Œ46-62è¡ŒæŠŠå·¥ä½œåœ¨ä¼ªç»ˆç«¯ä¸Šçš„åº”ç”¨ç¨‹åºçš„æ ‡å‡†è¾“å…¥ï¼Œæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯éƒ½é‡å®šå‘åˆ°ä¼ªç»ˆç«¯è®¾å¤‡ã€‚"]}),e.jsx(t,{code:`pid_t pty_xexec(struct pty_info *info, struct termios *termios,
		struct winsize *ws, char **argv)
{
	pid_t pid;
	int slave_fd;

	pid = fork();
	if (pid == -1) {
		perror("Error forking process");
		exit(EXIT_FAILURE);
	}

	if (pid > 0)
		return pid; /* Parent process returns child's PID */

	/* Child process */
	if (setsid() == -1) {
		perror("Error creating new session");
		exit(EXIT_FAILURE);
	}

	slave_fd = open(info->slave_name, O_RDWR);
	if (slave_fd == -1) {
		fprintf(stderr, "Error opening slave PTY '%s': %s\\n",
			info->slave_name, strerror(errno));
		exit(EXIT_FAILURE);
	}

	assert(termios != NULL);
	assert(ws != NULL);
	/* Set terminal attributes */
	if (tcsetattr(slave_fd, TCSANOW, termios) == -1) {
		fprintf(stderr,
			"Error setting terminal attributes for PTY '%s': %s\\n",
			info->slave_name, strerror(errno));
		exit(EXIT_FAILURE);
	}
	/* Set window size */
	if (ioctl(slave_fd, TIOCSWINSZ, ws) == -1) {
		fprintf(stderr, "Error setting window size for PTY '%s': %s\\n",
			info->slave_name, strerror(errno));
		exit(EXIT_FAILURE);
	}

	/* Redirect standard input/output/error to the PTY */
	if (dup2(slave_fd, STDIN_FILENO) != STDIN_FILENO) {
		fprintf(stderr, "Error redirecting stdin to PTY '%s': %s\\n",
			info->slave_name, strerror(errno));
		exit(EXIT_FAILURE);
	}
	if (dup2(slave_fd, STDOUT_FILENO) !=
	    STDOUT_FILENO) {
		fprintf(stderr, "Error redirecting stdout to PTY '%s': %s\\n",
			info->slave_name, strerror(errno));
		exit(EXIT_FAILURE);
	}
	if (dup2(slave_fd, STDERR_FILENO) !=
	    STDERR_FILENO) {
		fprintf(stderr, "Error redirecting stderr to PTY '%s': %s\\n",
			info->slave_name, strerror(errno));
		exit(EXIT_FAILURE);
	}

	/* Close the master PTY */
	close(info->master_fd);

	/* Execute the command */
	if (!argv || !*argv) {
		execlp("bash", NULL);
		perror("Error executing bash");
		exit(EXIT_FAILURE);
	}

	execvp(*argv, argv);

	fprintf(stderr, "Error executing command '%s", *argv++);
	while (*argv) {
		fprintf(stderr, " %s", *argv);
		argv++;
	}
	fprintf(stderr, "': %s\\n", strerror(errno));
	exit(EXIT_FAILURE);
}
`,language:"c"}),e.jsxs("p",{className:"indent",children:["window.cå’Œwindow.hä¸­ï¼Œç”¨",e.jsx("code",{children:"struct window"}),"æŠ½è±¡ä¸€ä¸ªç›‘å¬åœ¨",e.jsx("code",{children:"w.socket"}),"ä¸Šï¼Œè¿›ç¨‹å·ä¸º",e.jsx("code",{children:"w.pid"}),"çš„åç«¯ã€‚æˆ‘åœ¨ä»£ç ä¸­ä¹ŸæŠŠåç«¯ç§°ä½œä¸€ä¸ªwindow taskï¼Œæˆ–è€…ä¸€ä¸ªdaemonï¼ˆæ„æ€æ˜¯å®ˆæŠ¤è¿›ç¨‹ï¼Œä¸€èˆ¬å®ˆæŠ¤è¿›ç¨‹æ°¸ä¸ç»“æŸï¼Œä¸€ç›´åœ¨åå°å·¥ä½œã€‚åç«¯åˆ™ä¸€ç›´åœ¨åå°ç›‘å¬socketå‡†å¤‡è¿æ¥ï¼Œç±»ä¼¼å®ˆæŠ¤è¿›ç¨‹ï¼‰ã€‚",e.jsx("code",{children:"struct window_vec"}),"ç”¨æ¥ä¿å­˜è®¸å¤šä¸ªåç«¯ï¼Œè¿™æ ·å‰ç«¯å¯ä»¥é€‰æ‹©ä¸€ä¸ªåç«¯è¿›è¡Œè¿æ¥ã€‚",e.jsx("code",{children:"window_xstart"}),"ç”±å‰ç«¯è°ƒç”¨ï¼Œç”¨æ¥å¯åŠ¨ä¸€ä¸ªåç«¯è¿›ç¨‹ã€‚åœ¨ä»£ç 18-30è¡Œï¼Œ",e.jsx("code",{children:"window_xstart"}),"æŠŠåç«¯è¿›ç¨‹çš„ä¿¡æ¯ç”¨æŒ‡å‘",e.jsx("code",{children:"struct window"}),"çš„æŒ‡é’ˆè¿”å›ç»™å‰ç«¯è¿›ç¨‹ã€‚è€Œforkå‡ºçš„å­è¿›ç¨‹åˆ™è°ƒç”¨",e.jsx("code",{children:"do_window_task"}),"æ­£å¼æˆä¸ºåç«¯è¿›ç¨‹ã€‚",e.jsx("code",{children:"window_vec_store"}),"å°†æ‰€æœ‰åç«¯è¿›ç¨‹çš„ä¿¡æ¯ä¿å­˜åˆ°",e.jsx("code",{children:"$HOME/.myscreen"}),"ã€‚",e.jsx("code",{children:"window_vec_load"}),"åˆ™å°†æ‰€æœ‰åç«¯è¿›ç¨‹çš„ä¿¡æ¯åŠ è½½åˆ°",e.jsx("code",{children:"struct window_vec"}),"ä¸­ã€‚"]}),e.jsx(t,{code:`struct window *window_xstart(char *name, struct termios *termios,
			     struct winsize *ws, char **argv)
{
	struct window *win;
	struct pty_info *pty_info = NULL;
	char *socket_path = NULL;
	pid_t pid;

	/* Create socket for communication */
	socket_path = socket_path_xcreate();
	/* Open pty device */
	pty_info = pty_info_xalloc();

	pid = fork();
	if ((pid) < 0)
		ferror_raw_die("Error forking process for window task");
	else if (pid > 0) {
		win = (struct window *)calloc(1, sizeof(struct window));
		if (win == NULL)
			ferror_raw_die(
				"Error allocating memory for window struct");
		win->name = strdup(name);
		win->device = strdup(pty_info->slave_name);
		win->socket = socket_path;
		win->pid = pid;
		if (win->name == NULL || win->device == NULL ||
		    win->socket == NULL)
			ferror_raw_die("Error allocating memory for window");
		pty_info_free(pty_info);
		return win;
	}

	/* Window task start here */
	do_window_task(pty_info, socket_path, termios, ws, argv);
	/*
	 * Since do_window_task() never returns, no need to free
	 * socket_path and pty_info here
	 */
	return NULL;
}
`,language:"c"})]})}function y(){return e.jsxs("div",{children:[e.jsxs("p",{className:"indent",children:["å‰ç«¯ç¨‹åºä¸»è¦å†™åœ¨myscreen.cä¸­ï¼Œå…¶ä¸­åŒ…æ‹¬",e.jsx("code",{children:"main()"}),"å‡½æ•°ï¼šè´Ÿè´£åˆå§‹åŒ–å’ŒCLIï¼ˆè§£æå‘½ä»¤è¡Œå‚æ•°ï¼‰ï¼Œä»¥åŠ",e.jsx("code",{children:"do_interact_window()"}),"ï¼šç”¨æ¥å’Œåç«¯å¥—æ¥å­—äº¤äº’ã€‚",e.jsx("code",{children:"main()"}),"å‡½æ•°åœ¨è§£æå®Œæ¯•å‘½ä»¤è¡Œå‚æ•°åï¼Œé¦–å…ˆåˆå§‹åŒ–äº†ä¸€äº›signal handlerï¼Œè¿™äº›signal handleçš„ä½œç”¨æ˜¯æ¢å¤ç»ˆç«¯çš„å±æ€§ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ï¼Œå‰ç«¯ä¸ºäº†åªå……å½“ä¸­è½¬çš„ä½œç”¨ï¼Œè¿›å…¥äº†rawæ¨¡å¼ï¼Œå¦‚æœå‰ç«¯è¿›ç¨‹åœ¨è¿è¡Œä¸­å› ä¸ºä¿¡å·æˆ–è€…æ˜¯æŸäº›è°ƒç”¨å‘ç”Ÿäº†é”™è¯¯é€€å‡ºï¼Œåº”è¯¥åœ¨é€€å‡ºå‰æ¢å¤æˆæ­£å¸¸çš„ç»ˆç«¯æ¨¡å¼ã€‚å¦åˆ™ï¼Œä½ ä¼šå‘ç°ç”±äºrawæ¨¡å¼ä¸‹ä¸ä¼šæŠŠ'\\n'è½¬æ¢æˆ'\\n\\r'ï¼Œæ­£å¸¸ç¨‹åºçš„è¾“å‡ºåœ¨rawæ¨¡å¼ä¸‹ä¼šéå¸¸ä¹±ã€‚å‡è®¾ç”¨æˆ·æ²¡æœ‰è¾“å…¥--attachæˆ–è€…--listï¼Œé‚£ä¹ˆ",e.jsx("code",{children:"main()"}),"åœ¨ç¬¬15è¡ŒæŠŠå½“å‰ç»ˆç«¯è®¾ç½®ä¸ºrawæ¨¡å¼ï¼Œå¹¶æŠŠæ­£å¸¸çš„ç»ˆç«¯å±æ€§ä¿å­˜åˆ°orign_termiosã€‚åœ¨ç¬¬20è¡Œå¯åŠ¨ä¸€ä¸ªåå°è¿›ç¨‹è¿è¡Œç”¨æˆ·é€šè¿‡",e.jsx("code",{children:"argv"}),"æŒ‡å®šçš„å‘½ä»¤ï¼Œåœ¨ç¬¬22è¡Œè¿›å…¥",e.jsx("code",{children:"do_interact_window()"}),"å’Œåç«¯é€šè¿‡socketäº¤äº’ã€‚"]}),e.jsx(t,{code:`int main(int argc, char **argv)
{
	/* parse options */
	signal(SIGWINCH, sigwinch_handler);
	signal(SIGABRT, reset_tty_sig);
	signal(SIGKILL, reset_tty_sig);
	signal(SIGINT, reset_tty_sig);
	signal(SIGTERM, reset_tty_sig);
	atexit(reset_tty);
	windows = window_vec_xalloc();
	window_vec_load(windows, screen_store);
	if (mode == START) {
		char window_name[32] = { 0 };

		tty_set_raw(STDIN_FILENO, &origin_termios);
		raw_mode = 1;
		tty_get_winsize(STDIN_FILENO, &ws);
		snprintf(window_name, 32, "myscreen.%u",
			 (unsigned int)windows->nr);
		win = window_xstart(window_name, &origin_termios, &ws, argv);

		task_ret = do_interact_window(win);
		if (task_ret == 0)
			window_vec_add(windows, win);
		else
			/* Failed or killed */
			window_free(win);
	} /* ignore attach and list for simplicity */
	window_vec_save(windows, screen_store);
	window_vec_free(windows);

	reset_tty();
}`,language:"c"}),e.jsxs("p",{className:"indent",children:[e.jsx("code",{children:"do_interact_window()"}),"åšçš„äº‹æƒ…éå¸¸ç®€å•ï¼Œé¦–å…ˆé€šè¿‡",e.jsx("code",{children:"socket_client_xstart()"}),"å’Œåç«¯è¿›ç¨‹å»ºç«‹TCPè¿æ¥ï¼Œæ¥ç€ï¼ŒæŠŠsocketä¸­çš„è¾“å‡ºå†™åˆ°stdoutï¼ˆSTDOUT_FILENOï¼‰ä¸­ï¼ŒæŠŠstdinï¼ˆSTDIN_FILENOï¼‰ä¸­çš„è¾“å…¥å†™åˆ°socketä¸­ã€‚ä¸è¿‡é™¤äº†å†™å…¥æ­£å¸¸çš„ç”¨æˆ·è¾“å‡ºï¼Œ",e.jsx("code",{children:"do_interact_window()"}),"ä¸­éœ€è¦åšä¸‰ä»¶äº‹ï¼š1. å½“çª—å£å¤§å°æ”¹å˜æ—¶ï¼ˆæ¥æ”¶åˆ°SIGWINCHæ—¶ï¼‰ï¼Œå‘Šè¯‰åç«¯è¿›ç¨‹æ–°çš„çª—å£å¤§å°ï¼Œå¦‚ä»£ç 17-29è¡Œæ‰€ç¤ºï¼›2. åœ¨æ¥æ”¶åˆ°CTRL-a dæ—¶ï¼Œè¿”å›0ï¼Œè¡¨ç¤ºåç«¯è¿›ç¨‹ä»ç„¶å¯ä»¥ç»§ç»­é€šä¿¡ï¼›3. åœ¨æ¥æ”¶åˆ°CTRL-a kæ—¶ï¼Œæ€æ­»åç«¯è¿›ç¨‹ï¼Œè¿”å›-1ï¼Œè¡¨ç¤ºåç«¯è¿›ç¨‹å·²ç»ç»ˆæ­¢ï¼Œå¯ä»¥é‡Šæ”¾èµ„æºã€‚"]}),e.jsx(t,{code:`static int do_interact_window(struct window *win)
{
	int sock_fd, nfds;
	char sock_buf[256];
	fd_set read_set;
	int ret;

	sock_fd = socket_client_start(win->socket);
	if (sock_fd < 0) {
		ferror_raw("Error connecting to socket %s", win->socket);
		return -1;
	}
	nfds = sock_fd > STDIN_FILENO ? sock_fd + 1 : STDIN_FILENO + 1;
	for (;;) {
		char c;

		if (window_ch) {
			struct winsize ws;
			char winch_buf[5] = { [0] = 'w' };
			uint16_t *p = (uint16_t *)(winch_buf + 1);

			tty_get_winsize(STDIN_FILENO, &ws);
			window_ch = 0;
			p[0] = ws.ws_row;
			p[1] = ws.ws_col;
			if (write(sock_fd, winch_buf, 5) != 5)
				FAIL(perror_raw(
					"Error sending window change to socket"));
		}

		FD_ZERO(&read_set);
		FD_SET(STDIN_FILENO, &read_set);
		FD_SET(sock_fd, &read_set);
		if (select(nfds, &read_set, NULL, NULL, NULL) < 0) {
			if (errno == EINTR)
				continue; /* Interrupted by signal, retry select
					   */
			FAIL(perror_raw(
				"Error in select from STDIN and socket"));
		}

		if (FD_ISSET(sock_fd, &read_set)) {
			/* read sock_fd and write to STDOUT_FILENO */
		} else if (FD_ISSET(STDIN_FILENO, &read_set)) {
			if (c != CTRL_A) {
				/* read STDIN_FILENO and write to sock_fd */
			}

			/*
			 * c is CTRL-A, if the next char is 'd' or 'k', we
			 * detach or kill the window. Otherwise we ignore the
			 * next character.
			 */
			if (read(STDIN_FILENO, &c, 1) != 1)
				FAIL(perror_raw(
					"Error reading char from STDIN after CTRL-A"));
			switch (c) {
			case DETACH:
				ret = 0;
				ferror_raw("Detach from window %s: pid %d",
					win->name, win->pid);
				goto cleanup;
			case KILL:
				kill(win->pid, SIGKILL);
				ret = -1;
				ferror_raw("Kill window %s: pid %d",
					win->name, win->pid);
				goto cleanup;
			default:
				/* ignore unknown char */
				break;
			}
		}
	}

cleanup:
	close(sock_fd);
	return ret;
}
`,language:"c"})]})}function E(){return e.jsxs("div",{children:[e.jsxs("p",{className:"indent",children:["ä½ æ˜¯å¦è¿˜è®°å¾—åšå®¢å¼€å¤´çš„å¯¹è¯ï¼Œå¦‚æœç”¨æˆ·ç™»å‡ºï¼Œå¦‚ä½•è®©è¿›ç¨‹ç»§ç»­è¿è¡Œï¼Ÿå¯¹äºåç«¯ï¼Œæˆ‘ä»¬é¢ä¸´ç€åŒæ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¸Œæœ›åç«¯ç¨‹åºä¸€ç›´ç›‘å¬å¥—æ¥å­—ï¼Œç­‰å¾…å‰å°è¿›ç¨‹çš„è¿æ¥ï¼Œå¹¶ä¸”ä¸è¦å› ä¸ºç”¨æˆ·é€€å‡ºå°±ç»ˆæ­¢ã€‚å¦‚æœä½ ç†Ÿæ‚‰UNIXç³»ç»Ÿï¼Œä½ ä¹Ÿè®¸å·²ç»çŒœåˆ°è¦ç”¨",e.jsx("code",{children:"setsid"}),"ç³»ç»Ÿè°ƒç”¨ã€‚",e.jsx("code",{children:"setsid"}),"è¡¨ç¤ºå¼€å¯ä¸€ä¸ªæ–°ä¼šè¯ã€‚ä¸€ä¸ªä¼šè¯ï¼ˆsessionï¼‰é€šå¸¸å’Œä¸€ä¸ªç»ˆç«¯ç›¸å…³è”ï¼Œå½“ç”¨æˆ·é€€å‡ºç»ˆç«¯æ—¶ï¼Œç»ˆç«¯é©±åŠ¨ä¼šå‘æ‰€æœ‰å±äºè¯¥ä¼šè¯çš„è¿›ç¨‹å‘é€SIGHUPã€‚å¼€å¯ä¸€ä¸ªæ–°ä¼šè¯å°±æ„å‘³ç€ä¸ä¼šæ”¶åˆ°SIGHUPï¼Œäºæ˜¯åç«¯è¿›ç¨‹å°±å¯ä»¥æ°¸è¿œè¿è¡Œäº†ã€‚åç«¯è¿›ç¨‹çš„ä»£ç ä¸»è¦å†™åœ¨window.cä¸­çš„",e.jsx("code",{children:"do_interact_window()"}),"ä¸­ã€‚",e.jsx("code",{children:"do_interact_window()"}),"é¦–å…ˆå¼€å¯ä¸€ä¸ªæ–°ä¼šè¯æˆä¸ºå®ˆæŠ¤è¿›ç¨‹ï¼Œæ¥ç€åœ¨ä¼ªç»ˆç«¯ä¸Šfork+execä¸€ä¸ªç”¨æˆ·æŒ‡å®šçš„ï¼ˆæˆ–é»˜è®¤bashï¼‰shellå‘½ä»¤ï¼Œéšåå¯åŠ¨å¥—æ¥å­—æœåŠ¡å™¨ï¼Œå…è®¸å‰ç«¯è¿›è¡Œè¿æ¥ã€‚åœ¨ç¬¬27è¡Œå’Œå‰ç«¯è¿æ¥æˆåŠŸåï¼Œ",e.jsx("code",{children:"do_interact_window()"}),"å¯èƒ½åšä¸‰ä»¶äº‹ï¼š1. ä»å¥—æ¥å­—è¯»å‡ºä¸€ä¸ªç”¨æˆ·è¾“å…¥çš„å­—ç¬¦å‘é€ç»™ä¼ªç»ˆç«¯ï¼›2. ä»ä¼ªç»ˆç«¯è¯»å‡ºç¨‹åºè¾“å‡ºï¼Œé€šè¿‡å¥—æ¥å­—å‘é€ç»™å‰ç«¯ï¼›3. ä»å¥—æ¥å­—è¯»å‡ºæ–°çš„çª—å£å¤§å°ï¼Œè®¾ç½®ä¼ªç»ˆç«¯çª—å£å¤§å°ï¼Œè¿™ä¼šå¯¼è‡´æ‰€æœ‰è¿è¡Œåœ¨ä¼ªç»ˆç«¯ä¸Šçš„ç¨‹åºï¼ˆæ¯”å¦‚vimï¼‰éƒ½æ”¶åˆ°SIGWINCHä¿¡å·ã€‚"]}),e.jsx(t,{code:`static void do_window_task(struct pty_info *pty_info, char *socket_path,
			   struct termios *termios, struct winsize *ws,
			   char **argv)
{
	int master_fd, socket_fd;

	if (setsid() <= 0)
		perror_raw_die("Error creating new session in window task");

	master_fd = pty_info->master_fd;
	/* Start a socket daemon listen on socket_path */
	socket_fd = socket_server_xstart(socket_path);
	/* Start a child process runs on pty */
	pty_xexec(pty_info, termios, ws, argv);

	/*
	 * This for loop never breaks, this daemon only exit when receive
	 * a SIGKILL signal.
	 */
	for (;;) {
		int cfd, nfds;
		char socket_buf[4];
		char pty_buf[257];
		fd_set read_fds;

		/* Start a connection */
		cfd = socket_server_xaccept(socket_fd);
		nfds = cfd > master_fd ? cfd + 1 : master_fd + 1;

		for (;;) {
			int n;

			FD_ZERO(&read_fds);
			FD_SET(cfd, &read_fds);
			FD_SET(master_fd, &read_fds);
			if (select(nfds, &read_fds, NULL, NULL, NULL) < 0) {
				if (errno == EINTR)
					continue; /* Interrupted by signal,
						     retry select */
				perror_raw(
					"Error in select on socket and pty master");
			}

			if (FD_ISSET(cfd, &read_fds)) {
				/* Read from socket */
				n = read(cfd, socket_buf, 1);
				if (n < 0)
					perror_raw_die(
						"Error reading from socket");
				else if (n == 0) {
					/*
					 * This means \`myscreen\` detach from
					 * this window, so break and wait for
					 * the next connection
					 */
					close(cfd);
					break;
				}

				switch (socket_buf[0]) {
				case CHAR_MODE:
					if (read(cfd, socket_buf, 1) != 1)
						perror_raw_die(
							"Error reading char from socket");
					if (write(master_fd, socket_buf, 1) !=
					    1)
						perror_raw_die(
							"Error writing char to pty master");
					break;
				case WINCH_MODE:
					if (read(cfd, socket_buf, 4) != 4)
						perror_raw_die(
							"Error reading window size from socket");
					pty_xset_winsize(master_fd, socket_buf);
					break;
				default:
					ferror_raw_die(
						"Unknown command from socket: %c",
						socket_buf[0]);
				}
			}

			if (FD_ISSET(master_fd, &read_fds)) {
				/* Read from pty master */
				n = read(master_fd, pty_buf,
					 sizeof(pty_buf) - 1);
				if (n < 0)
					perror_raw_die(
						"Error reading from pty master");
				else if (n == 0) {
					ferror_raw("PTY closed");
					exit(EXIT_SUCCESS);
				}
				if (write(cfd, pty_buf, n) != n)
					perror_raw_die(
						"Error writing to socket from pty master");
			}
		}
	}
}`,language:"c"})]})}const a=[{id:"introTerm",label:"ç»ˆç«¯",level:2},{id:"controlTerm",label:"ç»ˆç«¯é©±åŠ¨",level:3},{id:"introWin",label:"çª—å£ç®¡ç†",level:2},{id:"introCode",label:"myscreen",level:2},{id:"codeStruct",label:"myscreenç»„æˆ",level:3},{id:"codeFrontEnd",label:"myscreenå‰ç«¯",level:3},{id:"codeDaemon",label:"myscreenå®ˆæŠ¤è¿›ç¨‹ï¼ˆåç«¯ï¼‰",level:3},{id:"theEnd",label:"ç»“æŸè¯­",level:2}];function v({sectionRefs:i}){const[o,s]=d.useState("");return d.useEffect(()=>{const r=new IntersectionObserver(n=>{n.forEach(c=>{c.isIntersecting&&s(c.target.id)})},{rootMargin:"-40% 0px -60% 0px",threshold:0});return Object.values(i.current).forEach(n=>{n&&r.observe(n)}),()=>r.disconnect()},[]),console.log("hello"+o),e.jsx("aside",{children:e.jsx("ul",{className:"myscreen-toc",children:a.map(r=>e.jsx("li",{children:e.jsx("a",{className:`${o===r.id?"active":"normal"}-${r.level}`,href:`#${r.id}`,onClick:n=>{var c;n.preventDefault(),(c=i.current[r.id])==null||c.scrollIntoView({behavior:"smooth"})},children:r.label})},r.id))})})}function T({sectionRefs:i}){const o=new Map([["introTerm",{content:x()}],["controlTerm",{content:p()}],["introWin",{content:g()}],["introCode",{content:I()}],["codeStruct",{content:k()}],["codeFrontEnd",{content:y()}],["codeDaemon",{content:E()}],["theEnd",{content:e.jsx("div",{children:e.jsx("p",{className:"indent",children:"wu~ï¼Œå¤§åŠŸå‘Šæˆã€‚å¦‚æœä½ æƒ³å®Œå–„è¿™ç¯‡åšå®¢ï¼Œfeel free to send me issue on githubã€‚Happy codingğŸ˜„"})})}]]);return e.jsxs("div",{className:"myscreen-body",children:[e.jsx("h1",{children:"MyScreen: ç¼–å†™ä¸€ä¸ªç®€å•çš„screenç¨‹åº"}),e.jsxs("div",{className:"notice",children:["ğŸ‘‰ ",e.jsx("code",{children:"myscreen"}),"çš„ä»£ç åœ¨",e.jsx("a",{href:"https://github.com/brandb97/myscreen.git",children:"è¿™ä¸ªä»“åº“"})]}),e.jsxs("p",{className:"content",children:[e.jsx("span",{className:"QA",children:"Q"}),"ï¼šå¦‚æœä½ æ­£åœ¨å‘½ä»¤è¡Œçª—å£ä¸­å·¥ä½œï¼Œæ¯”å¦‚ä½ æ‰“å¼€äº†ä¸€ä¸ªbashçª—å£ã€‚è¿™æ—¶ä½ å‡†å¤‡åšæœºå™¨å­¦ä¹ çš„è¯¾ç¨‹å®éªŒï¼Œè€Œå®éªŒç»“æœéœ€è¦å‡ ä¸ªå°æ—¶æ‰èƒ½è·‘å®Œã€‚ä½ å¸Œæœ›å¯ä»¥ä¸€è¾¹è¿è¡Œå®éªŒï¼Œä¸€è¾¹åœ¨bashä¸­å¤„ç†æ‰‹å¤´çš„å…¶ä»–å·¥ä½œï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"A"}),"ï¼šæˆ‘ä¼šç”¨bgå‘½ä»¤è®©å®éªŒè„šæœ¬åœ¨åå°è¿è¡Œï¼Œæˆ–è€…æˆ‘å¹²è„†æ–°å¼€ä¸€ä¸ªbashçª—å£è¿è¡Œå®éªŒè„šæœ¬ã€‚",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"Q"}),"ï¼šå¯æ˜¯å®éªŒå¿…é¡»åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå®Œæˆï¼Œå¦‚æœä½ çš„æœºå™¨å­¦ä¹ è€å¸ˆç–¯äº†ï¼Œç»™ä½ ä»¬å®‰æ’çš„å®éªŒéœ€è¦è¿è¡Œ12ä¸ªå°æ—¶ï¼Œä½†æ˜¯ä½ æ²¡æ³•12ä¸ªå°æ—¶éƒ½åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šä¿æŒç™»é™†çŠ¶æ€ï¼Œä½ è¯¥æ€ä¹ˆåŠï¼Ÿ",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"A"}),"ï¼šæˆ‘æ•¢è‚¯å®šå—äº¬å¤§å­¦çš„è€å¸ˆä¸ä¼šè¿™ä¹ˆåšçš„......",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"Q"}),"ï¼šYou never knowï¼",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"A"}),"ï¼šå¥½å§ï¼Œå‡è®¾ç°å®çœŸçš„å¦‚æ­¤ï¼Œæˆ‘ç¢°å·§çŸ¥é“å½“é€€å‡ºbashæ—¶ï¼Œbashä¼šå‘æ‰€æœ‰åå°ç¨‹åºå‘é€SIGHUPä¿¡å·ã€‚è®©å®éªŒè„šæœ¬å¿½ç•¥SIGHUPå¾ˆç®€å•ï¼Œä½¿ç”¨nohup......",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"Q"}),"ï¼šä½ çš„è€å¸ˆä¸å‡†ä½ å®‰è£…nohup",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"A"}),"ï¼šä½ æ˜¯ä¸æ˜¯æƒ³è®©æˆ‘è¯´screen",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"Q"}),"ï¼šexactlyï¼screenå¯ä»¥æ–°å»ºä¸€ä¸ªçª—å£ï¼Œå¹¶åœ¨è¿™ä¸ªçª—å£ä¸­è¿è¡Œä»»ä½•ç¨‹åºã€‚æŒ‰ä¸‹CTRL-A då°±å¯ä»¥è®©è¿™ä¸ªçª—å£åœ¨åå°è¿è¡Œï¼Œå³ä½¿é€€å‡ºç™»é™†ä¹Ÿæ²¡æœ‰å…³ç³»ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ç»™ä½ è®²è®²æ€ä¹ˆæ ·å†™ä¸€ä¸ªå…·æœ‰å’Œscreenç±»ä¼¼åŠŸèƒ½çš„myscreenç¨‹åºå§ã€‚",e.jsx("br",{}),e.jsx("span",{className:"QA",children:"A"}),"ï¼šTL;DR"]}),a.map(s=>{var r;return e.jsxs("section",{id:s.id,ref:n=>i.current[s.id]=n,className:"myscreen-section",children:[s.level===2?e.jsxs("h2",{children:[e.jsx("a",{href:`#${s.id}`,className:"anchor-link",children:"Â§"})," ",s.label]}):e.jsxs("h3",{children:[e.jsx("a",{href:`#${s.id}`,className:"anchor-link",children:"Â§"})," ",s.label]}),e.jsx("div",{className:"content",children:(r=o.get(s.id))==null?void 0:r.content})]},s.id)})]})}function L(){const i=d.useRef({});return e.jsxs(e.Fragment,{children:[e.jsx(_,{}),e.jsxs("div",{className:"myscreen-layout",children:[e.jsx(v,{sectionRefs:i}),e.jsx(T,{sectionRefs:i})]}),e.jsx(h,{})]})}l.createRoot(document.getElementById("root")).render(e.jsx(d.StrictMode,{children:e.jsx(w,{children:e.jsx(L,{})})}));
